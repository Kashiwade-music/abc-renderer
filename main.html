<html>
  <head>
    <title>Home</title>
  </head>
  <body>
    <script src="https://cdn.jsdelivr.net/npm/abcjs@6.2.3/dist/abcjs-basic-min.min.js"></script>
    <link
      href="https://cdn.jsdelivr.net/npm/abcjs@6.2.3/abcjs-audio.min.css"
      rel="stylesheet"
    />
    <div class="score">
      X: 1
      M: 4/4
      L: 1/8
      K: Emin
      |:D2|"Em"EBBA B2 EB|\
          ~B2 AB dBAG|\
          "D"FDAD BDAD|\
          FDAD dAFD|
      "Em"EBBA B2 EB|\
          B2 AB defg|\
          "D"afe^c dBAF|\
          "Em"DEFD E2:|
      |:gf|"Em"eB B2 efge|\
          eB B2 gedB|\
          "D"A2 FA DAFA|\
          A2 FA defg|
      "Em"eB B2 eBgB|\
          eB B2 defg|\
          "D"afe^c dBAF|\
          "Em"DEFD E2:|
  </div>
  <div class="audio"></div>

  <div class="score">
      M:4/4
      L:1/4
      K:C
      cBAG | FEDC ||
      </div>
  <div class="audio"></div>
  <style>
      .color {
        stroke: red;
        fill: red;
      }
    </style>
    <script>
      var timingCallbacksStateArray = [];

      class TimingCallbacksState {
        constructor(id, visualObj) {
          this.id = id;
          this.visualObj = visualObj;
          this.lastEls = [];
          this.isRunning = false;
          this.cursor = this.createCursor();
          this.timingCallback = new ABCJS.TimingCallbacks(this.visualObj[0], {
            beatCallback: this.beatCallback.bind(this),
            eventCallback: this.eventCallback.bind(this),
          });
        }

        createCursor() {
          var svg = document.querySelector("#score" + this.id + " svg");
          var cursor = document.createElementNS(
            "http://www.w3.org/2000/svg",
            "line"
          );
          cursor.setAttribute("class", "abcjs-cursor");
          cursor.setAttributeNS(null, "x1", 0);
          cursor.setAttributeNS(null, "y1", 0);
          cursor.setAttributeNS(null, "x2", 0);
          cursor.setAttributeNS(null, "y2", 0);
          svg.appendChild(cursor);
          return cursor;
        }

        beatCallback(
          currentBeat,
          totalBeats,
          lastMoment,
          position,
          debugInfo
        ) {
          var x1, x2, y1, y2;
          if (currentBeat === totalBeats) {
            x1 = 0;
            x2 = 0;
            y1 = 0;
            y2 = 0;
          } else {
            x1 = position.left - 2;
            x2 = position.left - 2;
            y1 = position.top;
            y2 = position.top + position.height;
          }

          console.log(this);
          this.cursor.setAttribute("x1", x1);
          this.cursor.setAttribute("x2", x2);
          this.cursor.setAttribute("y1", y1);
          this.cursor.setAttribute("y2", y2);
        }

        eventCallback(ev) {
          this.colorElements(ev.elements);
        }1

        colorElements(els) {
              var i;
              var j;
              for (i = 0; i < this.lastEls.length; i++) {
                for (j = 0; j < this.lastEls[i].length; j++) {
                  this.lastEls[i][j].classList.remove("color");
                }
              }
              for (i = 0; i < els.length; i++) {
                for (j = 0; j < els[i].length; j++) {
                  els[i][j].classList.add("color");
                }
              }
              this.lastEls = els;
            }

      }

      var isRendered = false;
      window.addEventListener("load", (event) => {
        console.log(ABCJS);
        console.log("ページが完全に読み込まれました");
        render();
      });
      function render() {
        if (!isRendered) {
          console.log("レンダリング中");
          // audioクラスのついているdivタグに、idを0から順に振っていく
          var audioObj = document.getElementsByClassName("audio");
          var scoreObj = document.getElementsByClassName("score");

          // 既にidが存在していたらbreakする
          for (var i in audioObj) {
            if (audioObj[i].id) {
              return;
            }
          }

          for (var i in audioObj) {
            audioObj[i].id = "audio" + i;
            scoreObj[i].id = "score" + i;
          }

          for (var i in scoreObj) {
            // スコアのレンダリング
            var visualObj = ABCJS.renderAbc(scoreObj[i], scoreObj[i].innerHTML);

            // スコアの再生
            var synthControl = new ABCJS.synth.SynthController();
            synthControl.load("#audio" + i, null, {
              displayRestart: true,
              displayPlay: true,
              displayProgress: true,
            });
            synthControl.setTune(visualObj[0], false);

            // アニメーション
            timingCallbacksStateArray.push(new TimingCallbacksState(i, visualObj));

            var startStop = function (index) {
              console.log("startStop at index", index);
              timingCallbacksStateArray[index].isRunning =
                !timingCallbacksStateArray[index].isRunning;

              if (timingCallbacksStateArray[index].isRunning) {
                timingCallbacksStateArray[index].timingCallback.start();
                console.log("call start");
              } else {
                timingCallbacksStateArray[index].timingCallback.pause();
                console.log("call pause");
              }
            };

            var reset = function (index) {
              timingCallbacksStateArray[index].timingCallback.reset();
              timingCallbacksStateArray[index].isRunning = false;
              console.log("call reset");
            };

            document
              .querySelector(
                "#audio" + i + " > div > button.abcjs-midi-start.abcjs-btn"
              )
              .addEventListener("click", startStop.bind(null, i));

            document
              .querySelector(
                "#audio" + i + " > div > button.abcjs-midi-reset.abcjs-btn"
              )
              .addEventListener("click", reset.bind(null, i));

            
          }
          isRendered = true;
        }
      }
    </script>
  </body>
</html>
